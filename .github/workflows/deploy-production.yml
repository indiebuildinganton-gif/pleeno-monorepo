name: Deploy to Vercel Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  # ============================================================================
  # DASHBOARD - First app, builds immediately
  # ============================================================================
  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} --cwd apps/dashboard
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_DASHBOARD }}
        timeout-minutes: 5

      - name: Build and Deploy to Vercel
        id: deploy
        run: |
          set -e
          echo "=== Starting Dashboard Deployment ==="
          echo "Time: $(date)"
          echo "Vercel CLI version: $(vercel --version)"

          # NOTE: Turbopack disabled via apps/dashboard/vercel.json (buildCommand: "next build")
          # See: docs/deployment/sequential-free-vercel/vercel_deployment_analysis.md

          # Deploy with 15-minute timeout and verbose output
          echo "Starting deployment... (timeout: 900 seconds)"
          timeout 900 vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes --cwd apps/dashboard > deployment.log 2>&1 &
          DEPLOY_PID=$!

          # Monitor the deployment with live output
          tail -f deployment.log &
          TAIL_PID=$!

          # Wait for deployment to complete
          if wait $DEPLOY_PID; then
            kill $TAIL_PID 2>/dev/null || true
            echo "âœ“ Deployment completed successfully"
          else
            EXIT_CODE=$?
            kill $TAIL_PID 2>/dev/null || true
            echo "ERROR: Deployment failed with exit code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âš ï¸ TIMEOUT: Deployment exceeded 15 minutes"
              echo "This likely means:"
              echo "  1. Build still hanging (check Vercel dashboard)"
              echo "  2. Or queued despite sequential execution"
              echo ""
              echo "Last 50 lines of output:"
              tail -50 deployment.log
            fi
            echo ""
            echo "Full deployment log:"
            cat deployment.log
            exit $EXIT_CODE
          fi

          # Extract URL from output - look for the actual deployment URL (*.vercel.app)
          # Vercel CLI outputs multiple URLs, we want the production deployment URL
          URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.vercel\.app' deployment.log | head -1)

          if [ -z "$URL" ]; then
            echo "ERROR: Could not extract deployment URL"
            echo "Searching for any https URL as fallback..."
            URL=$(grep -oP 'https://[^\s]+' deployment.log | grep -v "vercel.com" | head -1)
          fi

          if [ -z "$URL" ]; then
            echo "ERROR: Still could not extract deployment URL"
            echo "Full output:"
            cat deployment.log
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed dashboard to: $URL"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_DASHBOARD }}
        timeout-minutes: 18

      - name: Verify Deployment
        run: |
          echo "Dashboard deployed: ${{ steps.deploy.outputs.url }}"
          curl -I "${{ steps.deploy.outputs.url }}" | head -5

  # ============================================================================
  # ENTITIES - Waits for Dashboard
  # ============================================================================
  deploy-entities:
    name: Deploy Entities
    needs: deploy-dashboard
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} --cwd apps/entities
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ENTITIES }}
        timeout-minutes: 5

      - name: Build and Deploy to Vercel
        id: deploy
        run: |
          set -e
          echo "=== Starting Entities Deployment ==="
          echo "Time: $(date)"
          echo "Dashboard URL: ${{ needs.deploy-dashboard.outputs.url }}"

          # Deploy with 15-minute timeout and verbose output
          echo "Starting deployment... (timeout: 900 seconds)"
          timeout 900 vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes --cwd apps/entities > deployment.log 2>&1 &
          DEPLOY_PID=$!

          # Monitor the deployment with live output
          tail -f deployment.log &
          TAIL_PID=$!

          # Wait for deployment to complete
          if wait $DEPLOY_PID; then
            kill $TAIL_PID 2>/dev/null || true
            echo "âœ“ Deployment completed successfully"
          else
            EXIT_CODE=$?
            kill $TAIL_PID 2>/dev/null || true
            echo "ERROR: Deployment failed with exit code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âš ï¸ TIMEOUT: Deployment exceeded 15 minutes"
              echo "Last 50 lines of output:"
              tail -50 deployment.log
            fi
            echo ""
            echo "Full deployment log:"
            cat deployment.log
            exit $EXIT_CODE
          fi

          # Extract URL from output - look for the actual deployment URL (*.vercel.app)
          URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.vercel\.app' deployment.log | head -1)

          if [ -z "$URL" ]; then
            echo "ERROR: Could not extract deployment URL"
            echo "Searching for any https URL as fallback..."
            URL=$(grep -oP 'https://[^\s]+' deployment.log | grep -v "vercel.com" | head -1)
          fi

          if [ -z "$URL" ]; then
            echo "ERROR: Still could not extract deployment URL"
            echo "Full output:"
            cat deployment.log
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed entities to: $URL"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_ENTITIES }}
        timeout-minutes: 18

  # ============================================================================
  # PAYMENTS - Waits for Entities
  # ============================================================================
  deploy-payments:
    name: Deploy Payments
    needs: deploy-entities
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} --cwd apps/payments
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PAYMENTS }}
        timeout-minutes: 5

      - name: Build and Deploy to Vercel
        id: deploy
        run: |
          set -e
          echo "=== Starting Payments Deployment ==="
          echo "Time: $(date)"

          echo "Starting deployment... (timeout: 900 seconds)"
          timeout 900 vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes --cwd apps/payments > deployment.log 2>&1 &
          DEPLOY_PID=$!

          tail -f deployment.log &
          TAIL_PID=$!

          if wait $DEPLOY_PID; then
            kill $TAIL_PID 2>/dev/null || true
            echo "âœ“ Deployment completed successfully"
          else
            EXIT_CODE=$?
            kill $TAIL_PID 2>/dev/null || true
            echo "ERROR: Deployment failed with exit code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âš ï¸ TIMEOUT: Deployment exceeded 15 minutes"
              tail -50 deployment.log
            fi
            cat deployment.log
            exit $EXIT_CODE
          fi

          URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.vercel\.app' deployment.log | head -1)
          if [ -z "$URL" ]; then
            URL=$(grep -oP 'https://[^\s]+' deployment.log | grep -v "vercel.com" | head -1)
          fi
          if [ -z "$URL" ]; then
            echo "ERROR: Could not extract deployment URL"
            cat deployment.log
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed payments to: $URL"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_PAYMENTS }}
        timeout-minutes: 18

  # ============================================================================
  # AGENCY - Waits for Payments
  # ============================================================================
  deploy-agency:
    name: Deploy Agency
    needs: deploy-payments
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} --cwd apps/agency
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_AGENCY }}
        timeout-minutes: 5

      - name: Build and Deploy to Vercel
        id: deploy
        run: |
          set -e
          echo "=== Starting Agency Deployment ==="
          echo "Time: $(date)"

          echo "Starting deployment... (timeout: 900 seconds)"
          timeout 900 vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes --cwd apps/agency > deployment.log 2>&1 &
          DEPLOY_PID=$!

          tail -f deployment.log &
          TAIL_PID=$!

          if wait $DEPLOY_PID; then
            kill $TAIL_PID 2>/dev/null || true
            echo "âœ“ Deployment completed successfully"
          else
            EXIT_CODE=$?
            kill $TAIL_PID 2>/dev/null || true
            echo "ERROR: Deployment failed with exit code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âš ï¸ TIMEOUT: Deployment exceeded 15 minutes"
              tail -50 deployment.log
            fi
            cat deployment.log
            exit $EXIT_CODE
          fi

          URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.vercel\.app' deployment.log | head -1)
          if [ -z "$URL" ]; then
            URL=$(grep -oP 'https://[^\s]+' deployment.log | grep -v "vercel.com" | head -1)
          fi
          if [ -z "$URL" ]; then
            echo "ERROR: Could not extract deployment URL"
            cat deployment.log
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed agency to: $URL"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_AGENCY }}
        timeout-minutes: 18

  # ============================================================================
  # REPORTS - Waits for Agency
  # ============================================================================
  deploy-reports:
    name: Deploy Reports
    needs: deploy-agency
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} --cwd apps/reports
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_REPORTS }}
        timeout-minutes: 5

      - name: Build and Deploy to Vercel
        id: deploy
        run: |
          set -e
          echo "=== Starting Reports Deployment ==="
          echo "Time: $(date)"

          echo "Starting deployment... (timeout: 900 seconds)"
          timeout 900 vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes --cwd apps/reports > deployment.log 2>&1 &
          DEPLOY_PID=$!

          tail -f deployment.log &
          TAIL_PID=$!

          if wait $DEPLOY_PID; then
            kill $TAIL_PID 2>/dev/null || true
            echo "âœ“ Deployment completed successfully"
          else
            EXIT_CODE=$?
            kill $TAIL_PID 2>/dev/null || true
            echo "ERROR: Deployment failed with exit code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âš ï¸ TIMEOUT: Deployment exceeded 15 minutes"
              tail -50 deployment.log
            fi
            cat deployment.log
            exit $EXIT_CODE
          fi

          URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.vercel\.app' deployment.log | head -1)
          if [ -z "$URL" ]; then
            URL=$(grep -oP 'https://[^\s]+' deployment.log | grep -v "vercel.com" | head -1)
          fi
          if [ -z "$URL" ]; then
            echo "ERROR: Could not extract deployment URL"
            cat deployment.log
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed reports to: $URL"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_REPORTS }}
        timeout-minutes: 18

  # ============================================================================
  # SHELL - Waits for ALL 5 above, needs their URLs as build env vars
  # ============================================================================
  deploy-shell:
    name: Deploy Shell
    needs:
      - deploy-dashboard
      - deploy-entities
      - deploy-payments
      - deploy-agency
      - deploy-reports
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} --cwd apps/shell
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_SHELL }}
        timeout-minutes: 5

      - name: Build and Deploy to Vercel
        id: deploy
        run: |
          set -e
          echo "=== Starting Shell Deployment ==="
          echo "Time: $(date)"
          echo "All child app URLs:"
          echo "  - Dashboard: ${{ needs.deploy-dashboard.outputs.url }}"
          echo "  - Entities: ${{ needs.deploy-entities.outputs.url }}"
          echo "  - Payments: ${{ needs.deploy-payments.outputs.url }}"
          echo "  - Agency: ${{ needs.deploy-agency.outputs.url }}"
          echo "  - Reports: ${{ needs.deploy-reports.outputs.url }}"

          echo "Starting deployment... (timeout: 900 seconds)"
          timeout 900 vercel --prod \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --build-env NEXT_PUBLIC_DASHBOARD_URL="${{ needs.deploy-dashboard.outputs.url }}" \
            --build-env NEXT_PUBLIC_ENTITIES_URL="${{ needs.deploy-entities.outputs.url }}" \
            --build-env NEXT_PUBLIC_PAYMENTS_URL="${{ needs.deploy-payments.outputs.url }}" \
            --build-env NEXT_PUBLIC_AGENCY_URL="${{ needs.deploy-agency.outputs.url }}" \
            --build-env NEXT_PUBLIC_REPORTS_URL="${{ needs.deploy-reports.outputs.url }}" \
            --yes --cwd apps/shell > deployment.log 2>&1 &
          DEPLOY_PID=$!

          tail -f deployment.log &
          TAIL_PID=$!

          if wait $DEPLOY_PID; then
            kill $TAIL_PID 2>/dev/null || true
            echo "âœ“ Deployment completed successfully"
          else
            EXIT_CODE=$?
            kill $TAIL_PID 2>/dev/null || true
            echo "ERROR: Deployment failed with exit code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âš ï¸ TIMEOUT: Deployment exceeded 15 minutes"
              tail -50 deployment.log
            fi
            cat deployment.log
            exit $EXIT_CODE
          fi

          URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.vercel\.app' deployment.log | head -1)
          if [ -z "$URL" ]; then
            URL=$(grep -oP 'https://[^\s]+' deployment.log | grep -v "vercel.com" | head -1)
          fi
          if [ -z "$URL" ]; then
            echo "ERROR: Could not extract deployment URL"
            cat deployment.log
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed shell to: $URL"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_SHELL }}
        timeout-minutes: 18

  # ============================================================================
  # SUMMARY - Creates deployment report
  # ============================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - deploy-dashboard
      - deploy-entities
      - deploy-payments
      - deploy-agency
      - deploy-reports
      - deploy-shell
    if: always()

    steps:
      - name: Print deployment summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Child Apps" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard:** ${{ needs.deploy-dashboard.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Entities:** ${{ needs.deploy-entities.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Payments:** ${{ needs.deploy-payments.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Agency:** ${{ needs.deploy-agency.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reports:** ${{ needs.deploy-reports.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Shell App" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell:** ${{ needs.deploy-shell.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Production Domain" >> $GITHUB_STEP_SUMMARY
          echo "- https://plenno.com.au" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Report any failures
          if [ "${{ needs.deploy-dashboard.result }}" != "success" ]; then
            echo "âš ï¸ Dashboard deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-entities.result }}" != "success" ]; then
            echo "âš ï¸ Entities deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-payments.result }}" != "success" ]; then
            echo "âš ï¸ Payments deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-agency.result }}" != "success" ]; then
            echo "âš ï¸ Agency deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-reports.result }}" != "success" ]; then
            echo "âš ï¸ Reports deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-shell.result }}" != "success" ]; then
            echo "âš ï¸ Shell deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
