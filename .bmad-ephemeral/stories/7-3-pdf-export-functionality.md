# Story 7.3: PDF Export Functionality

Status: ready-for-dev

## Story

As an **Agency Admin**,
I want **to export reports to PDF format**,
so that **I can share professional-looking reports with stakeholders or college partners**.

## Acceptance Criteria

1. **Given** I have generated a report
   **When** I click "Export to PDF"
   **Then** a PDF file is downloaded with formatted report data

2. **And** the PDF includes: agency logo/name, report title, generation date, filters applied

3. **And** the PDF includes a formatted table with the report data

4. **And** the PDF includes summary totals

5. **And** the PDF has proper page breaks for large reports

6. **And** the filename includes the report type and timestamp

## Tasks / Subtasks

- [ ] **Task 1: Create PDF Export API Route** (AC: #1, 6)
  - [ ] Create API route: `GET /api/reports/payment-plans/export?format=pdf`
  - [ ] Accept all filter params from report generation (same as CSV export)
  - [ ] Accept `columns[]` query parameter for column selection
  - [ ] Query payment_plans with same logic as report generation and CSV export
  - [ ] Generate PDF using `@react-pdf/renderer`
  - [ ] Set HTTP response headers:
    - `Content-Type: application/pdf`
    - `Content-Disposition: attachment; filename="payment_plans_YYYY-MM-DD_HHmmss.pdf"`
  - [ ] Generate filename with timestamp: `payment_plans_${date}.pdf`
  - [ ] Test: Verify PDF downloads with correct filename
  - [ ] Test: Verify RLS filters by agency_id

- [ ] **Task 2: Create PDF Template with React Components** (AC: #2-4)
  - [ ] Design PDF template structure:
    - Header section: Agency logo, report title, generation date
    - Filters section: Display applied filters
    - Data table: Formatted report data
    - Footer section: Summary totals, page numbers
  - [ ] Create React PDF components in `packages/ui/src/pdf/`:
    - `PDFReportHeader.tsx`: Agency branding and metadata
    - `PDFFiltersSection.tsx`: Display applied filters
    - `PDFReportTable.tsx`: Formatted table with headers and data rows
    - `PDFReportFooter.tsx`: Summary totals and pagination
  - [ ] Create `pdf-styles.ts` with StyleSheet for PDF components
  - [ ] Format currency amounts: Display with currency symbol and thousand separators
  - [ ] Format dates: Display in user-friendly format (e.g., "Nov 10, 2025")
  - [ ] Test: Generate sample PDF and verify formatting

- [ ] **Task 3: Add Agency Logo/Branding** (AC: #2)
  - [ ] Extend `agencies` table with `logo_url` field (nullable TEXT)
  - [ ] Create Supabase Storage bucket `agency-logos` with public access
  - [ ] Create RLS policy for logo uploads: agencies can upload to their own folder
  - [ ] Create logo upload functionality in agency settings page:
    - File upload form with preview
    - Upload to Supabase Storage: `agency-logos/{agency_id}/logo.{ext}`
    - Store public URL in agencies.logo_url
  - [ ] Validate file type (PNG, JPG, SVG only) and size (max 2MB)
  - [ ] In PDF template:
    - Load agency logo from agencies.logo_url
    - Display logo in header (max 150x50px)
    - Fallback to agency name text if no logo
  - [ ] Display agency name and contact email below logo
  - [ ] Test: Upload logo → Generate PDF → Verify logo appears

- [ ] **Task 4: Include Report Metadata and Filters** (AC: #2)
  - [ ] Add report metadata section to PDF header:
    - Report title: "Payment Plans Report"
    - Generation date: "Generated on Nov 13, 2025 at 10:30 AM Brisbane"
    - Generated by: User name and email
  - [ ] Add filters section showing applied filters:
    - Date range: "From Nov 1, 2025 to Nov 30, 2025"
    - College/Branch: "College Name - Branch Name" (if filtered)
    - Student: "Student Name" (if filtered)
    - Status: "Active, Completed" (if filtered)
    - Contract expiration: "Expiring between Dec 1 - Dec 31, 2025" (if filtered)
  - [ ] Format filters as human-readable labels (not raw values)
  - [ ] If no filters applied, show "All payment plans"
  - [ ] Test: Generate PDF with various filters → Verify all filters displayed

- [ ] **Task 5: Format Data Table with Pagination** (AC: #3, 5)
  - [ ] Create responsive table layout:
    - Column headers with background shading
    - Alternating row colors for readability
    - Proper column widths based on content
    - Text wrapping for long values
  - [ ] Format table data:
    - Currency columns: Right-aligned, formatted with symbol and separators
    - Date columns: Formatted as "Nov 10, 2025"
    - Status columns: Badge-style formatting with colors
    - Text columns: Left-aligned, truncate if too long
  - [ ] Implement pagination:
    - Max 30 rows per page (adjust based on content density)
    - Repeat table headers on each page
    - Page numbers in footer: "Page 1 of 5"
    - Automatic page breaks when content overflows
  - [ ] Handle edge cases:
    - Wide tables: Adjust font size or orientation (landscape)
    - Many columns: Select most important columns only
    - Long text values: Truncate with ellipsis
  - [ ] Test: Generate PDF with 100+ rows → Verify pagination works

- [ ] **Task 6: Add Summary Totals Section** (AC: #4)
  - [ ] Calculate summary metrics:
    - Total records: Count of payment plans
    - Total amount: Sum of total_amount
    - Total expected commission: Sum of expected_commission
    - Total earned commission: Sum of earned_commission
    - Outstanding commission: expected - earned
  - [ ] Display summary in footer section:
    - Position below table on last page
    - Use bold font and larger size
    - Format currency with thousands separator
    - Visual separator (horizontal line) from table
  - [ ] Style summary for emphasis:
    - Use shaded background box
    - Green color for earned amounts
    - Red/orange for outstanding amounts
  - [ ] Test: Verify summary calculations match report data

- [ ] **Task 7: Add Export Button to Report UI** (AC: #1)
  - [ ] Add "Export to PDF" button to report builder page:
    - Location: Next to "Export CSV" button
    - Icon: Download icon (↓) or PDF icon
    - Label: "Export PDF"
  - [ ] Trigger API call with current filters and columns
  - [ ] Show loading spinner while PDF generates
  - [ ] Handle errors gracefully:
    - Show toast notification if export fails
    - Display error message with retry option
  - [ ] Test: Click button → PDF downloads with correct data

- [ ] **Task 8: Add Export Tracking** (AC: #1)
  - [ ] Log export events to activity_log table:
    - `entity_type: 'report'`
    - `action: 'exported'`
    - `description: "{{user}} exported {{report_type}} report to PDF ({{row_count}} rows, {{page_count}} pages)"`
    - `metadata: { report_type, format: 'pdf', row_count, page_count, filters }`
  - [ ] Track export in user activity feed
  - [ ] Monitor PDF generation performance (time taken)
  - [ ] Test: Verify export activity appears in recent activity feed

- [ ] **Task 9: Testing** (AC: All)
  - [ ] Write API route unit tests:
    - Test PDF export with all filters applied
    - Test PDF includes agency logo and branding
    - Test PDF includes report metadata and filters
    - Test PDF table formatting (headers, rows, columns)
    - Test PDF pagination (multiple pages)
    - Test PDF summary totals
    - Test filename generation with timestamp
    - Test RLS filtering by agency_id
  - [ ] Write integration tests:
    - Generate report → Click "Export PDF" → PDF downloads
    - Open PDF → Verify all sections present
    - Apply filters → Export PDF → Verify filtered data
    - Select columns → Export PDF → Verify only selected columns
    - Upload logo → Export PDF → Verify logo appears
  - [ ] Write error handling tests:
    - Invalid filters → Return 400 error
    - No data available → Return PDF with headers only
    - Database error → Return 500 error
    - Logo load failure → Fallback to text name
  - [ ] Test edge cases:
    - Export with 0 rows (empty report)
    - Export with 100+ rows (pagination)
    - Export with long text values (truncation)
    - Export without logo (text fallback)
    - Export with many columns (layout adjustment)

## Dev Notes

### Architecture Context

**Reporting Zone:**
- API route at `apps/reports/app/api/reports/payment-plans/export/route.ts`
- Reuses query logic from report generation API
- Extends CSV export with PDF formatting

**PDF Library:**
- Use `@react-pdf/renderer` (recommended for MVP)
  - React components to PDF conversion
  - Server-compatible (Node.js)
  - No browser dependency
  - Good for structured reports

**Alternative:** Puppeteer (HTML to PDF via headless Chrome) - higher resource usage, better for complex layouts

### Learnings from Previous Story (7.2)

**From Story 7.2: CSV Export Functionality (Status: ready-for-dev)**

This story builds directly on the patterns established in Story 7.2:

**Patterns to Reuse:**
- Same API route structure: `/api/reports/payment-plans/export`
- Same filter application logic
- Same query builder and RLS policies
- Same export tracking to activity_log
- Same error handling patterns

**Key Differences:**
- **Format:** PDF vs CSV (binary vs text)
- **Complexity:** Structured layout vs simple rows
- **Size:** Larger file size (~10x CSV)
- **Processing:** More CPU-intensive (rendering)
- **Use Case:** Stakeholder sharing vs data import

**New Patterns Introduced:**
- **React PDF Components:** Declarative PDF generation
- **Logo Upload:** Agency branding in reports
- **Pagination Logic:** Automatic page breaks
- **Professional Formatting:** Styled tables and layout

### Project Structure Notes

**API Route Organization:**
```
apps/reports/
├── app/
│   └── api/
│       └── reports/
│           └── payment-plans/
│               ├── route.ts                    # Report generation API
│               └── export/
│                   └── route.ts                # CSV/PDF export API (format param)
```

**PDF Template Components:**
```
packages/ui/
├── src/
│   └── pdf/
│       ├── PDFReportDocument.tsx              # Main document wrapper
│       ├── PDFReportHeader.tsx                # Agency branding header
│       ├── PDFFiltersSection.tsx              # Applied filters display
│       ├── PDFReportTable.tsx                 # Data table with pagination
│       ├── PDFReportFooter.tsx                # Summary totals footer
│       └── pdf-styles.ts                      # PDF stylesheet
```

**Database Schema Addition:**
```sql
-- Add logo_url to agencies table
ALTER TABLE agencies ADD COLUMN logo_url TEXT;

-- Create storage bucket for logos (via Supabase Dashboard or SQL)
INSERT INTO storage.buckets (id, name, public)
VALUES ('agency-logos', 'agency-logos', true);

-- RLS policy: agencies can upload to their own folder
CREATE POLICY "Agencies can upload own logos"
ON storage.objects FOR INSERT
TO authenticated
USING (
  bucket_id = 'agency-logos' AND
  (storage.foldername(name))[1] = (SELECT agency_id::text FROM users WHERE id = auth.uid())
);
```

### Key Technical Implementation Details

**PDF Generation Flow:**
1. Receive export request with filters
2. Query payment plans data (same as CSV export)
3. Load agency info (name, logo_url, contact_email)
4. Calculate summary totals
5. Split data into pages (30 rows per page)
6. Render React PDF components
7. Stream PDF to response
8. Log export activity

**Logo Upload Flow:**
1. User selects image file in agency settings
2. Validate file type and size
3. Upload to Supabase Storage: `agency-logos/{agency_id}/logo.{ext}`
4. Get public URL
5. Update agencies.logo_url
6. Display in PDF exports

**Pagination Strategy:**
- 30 rows per page (configurable)
- Repeat table headers on each page
- Summary only on last page
- Page numbers in footer
- Landscape orientation for wide tables

### References

- [Source: docs/epics.md#Story 7.3] - Story acceptance criteria and technical notes
- [Source: .bmad-ephemeral/stories/7-2-csv-export-functionality.md] - CSV export patterns to reuse
- [Source: docs/architecture.md#Reporting Zone] - Reporting component architecture
- [Source: docs/architecture.md#Multi-Tenant Isolation] - RLS policy patterns

## Change Log

- **2025-11-13**: Story created by SM agent via create-story workflow

## Dev Agent Record

### Context Reference

- .bmad-ephemeral/stories/7-3-pdf-export-functionality.context.xml

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
