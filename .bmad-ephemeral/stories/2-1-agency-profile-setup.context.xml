<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Agency Profile Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/2-1-agency-profile-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Agency Admin</asA>
    <iWant>to configure my agency's profile with basic information</iWant>
    <soThat>my agency identity is established in the system and my team knows which agency they're working in</soThat>
    <tasks>
- [ ] Extend agencies table with profile fields (AC: 1, 2)
  - [ ] Add migration for: name, contact_email, contact_phone, currency (default: AUD), timezone
  - [ ] Add validation constraints: name (required, max 255 chars), currency (enum or varchar), timezone (valid timezone string)
  - [ ] Test migration rollback for safety

- [ ] Create agency settings API endpoint (AC: 1, 2)
  - [ ] Implement PATCH /api/agencies/[id] route
  - [ ] Validate required fields: name, currency, timezone
  - [ ] Enforce authorization: only Agency Admins can edit agency settings
  - [ ] Return updated agency data or validation errors

- [ ] Build agency settings UI page (AC: 1)
  - [ ] Create /settings/agency page component
  - [ ] Build form with fields: name, contact_email, contact_phone, currency dropdown, timezone dropdown
  - [ ] Implement form validation on client side
  - [ ] Display success/error messages after save
  - [ ] Disable form during submission (loading state)

- [ ] Display agency name in header/navigation (AC: 3)
  - [ ] Fetch current agency data on app load
  - [ ] Display agency name in application header component
  - [ ] Update header when agency name changes (reactive state)

- [ ] Implement timezone-aware timestamp display (AC: 4)
  - [ ] Create utility function to convert UTC timestamps to agency timezone
  - [ ] Update all timestamp display components to use timezone utility
  - [ ] Test with various timezones (UTC, US Eastern, Australian Eastern, etc.)

- [ ] Add comprehensive tests
  - [ ] Unit tests: API validation logic, timezone conversion utility
  - [ ] Integration tests: PATCH /api/agencies/[id] with valid/invalid data
  - [ ] E2E tests: Load settings page, edit fields, save, verify persistence
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Given** I am an authenticated Agency Admin, **When** I access the agency settings page, **Then** I can view and edit my agency's name, contact information, default currency, and timezone

2. **And** changes are saved to the database with proper validation

3. **And** the agency name appears in the application header/navigation

4. **And** all timestamps display in the agency's configured timezone
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>pleeno - Epic Breakdown</title>
        <section>Epic 2: Agency & User Management → Story 2.1: Agency Profile Setup</section>
        <snippet>Enable agency self-service setup and team collaboration. As an Agency Admin, I want to configure my agency's profile with basic information including name, contact info, default currency, and timezone. Prerequisites: Story 1.3 (Authentication & Authorization Framework).</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Pleeno - Product Requirements Document</title>
        <section>FR-2: Agency Management → FR-2.1: Agency Profile</section>
        <snippet>Agency profile includes: name, logo, contact information, default commission structure (% rate, GST rules), default automation settings (due-soon threshold, overdue trigger time), timezone setting for accurate date/time calculations.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Pleeno - Product Requirements Document</title>
        <section>Multi-Tenancy Architecture</section>
        <snippet>PostgreSQL Row-Level Security (RLS) policies enforce tenant isolation at database layer. Every table includes agency_id foreign key. All queries automatically filtered by authenticated user's agency. Zero data leakage between agencies.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Pleeno - Product Requirements Document</title>
        <section>Role-Based Access Control (RBAC) → Admin Role</section>
        <snippet>Admin Role has full access to all agency data, can manage users (invite, remove, change roles), configure agency settings (commission structures, default terms), access audit logs, and export reports. Typical users: Agency owner, finance manager.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/1-1-project-infrastructure-initialization.md</path>
        <title>Story 1.1: Project Infrastructure Initialization</title>
        <section>Dev Notes → Technical Stack</section>
        <snippet>Next.js 14+ with App Router, TypeScript with strict mode, React 18+. PostgreSQL 15+ (Supabase recommended for managed PostgreSQL with built-in authentication and Row-Level Security). Folder structure: /app, /lib, /components, /types.</snippet>
      </doc>
    </docs>
    <code>
      <!-- Greenfield project - Story 1.1 not yet implemented -->
      <!-- Expected files to be created by this story: -->
      <artifact>
        <path>app/settings/agency/page.tsx</path>
        <kind>component</kind>
        <symbol>AgencySettingsPage</symbol>
        <lines></lines>
        <reason>Agency settings page component with form for editing agency profile</reason>
      </artifact>
      <artifact>
        <path>app/api/agencies/[id]/route.ts</path>
        <kind>api-route</kind>
        <symbol>PATCH handler</symbol>
        <lines></lines>
        <reason>API endpoint for updating agency profile with validation and RLS enforcement</reason>
      </artifact>
      <artifact>
        <path>lib/timezone.ts</path>
        <kind>utility</kind>
        <symbol>convertToAgencyTimezone</symbol>
        <lines></lines>
        <reason>Timezone conversion utility for displaying timestamps in agency's configured timezone</reason>
      </artifact>
      <artifact>
        <path>components/AgencyHeader.tsx</path>
        <kind>component</kind>
        <symbol>AgencyHeader</symbol>
        <lines></lines>
        <reason>Header component displaying agency name in navigation</reason>
      </artifact>
      <artifact>
        <path>types/agency.ts</path>
        <kind>types</kind>
        <symbol>Agency interface</symbol>
        <lines></lines>
        <reason>TypeScript types for Agency model including profile fields</reason>
      </artifact>
    </code>
    <dependencies>
      <!-- To be determined after Story 1.1 implementation -->
      <!-- Expected dependencies based on story requirements: -->
      <node>
        <package>next</package>
        <version>^14.0.0</version>
        <reason>Next.js App Router framework</reason>
      </node>
      <node>
        <package>react</package>
        <version>^18.0.0</version>
        <reason>React framework for UI components</reason>
      </node>
      <node>
        <package>typescript</package>
        <version>^5.0.0</version>
        <reason>TypeScript for type safety</reason>
      </node>
      <node>
        <package>date-fns-tz</package>
        <version>^2.0.0</version>
        <reason>Timezone conversion utilities (recommended in story)</reason>
      </node>
      <node>
        <package>zod</package>
        <version>^3.0.0</version>
        <reason>Schema validation for API endpoints</reason>
      </node>
      <node>
        <package>react-hook-form</package>
        <version>^7.0.0</version>
        <reason>Form management (recommended in story)</reason>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Multi-Tenant Security: RLS policies on agencies table ensure users only access their own agency. API endpoint must verify: req.user.agency_id === params.id. Never trust client-provided agency_id - always use authenticated user's agency_id.</constraint>
    <constraint>Authorization: Only users with agency_admin role can edit agency settings. Enforce at both API and UI layers.</constraint>
    <constraint>State Management: Agency profile should be loaded on app initialization (client-side context). Use React Context or state management library (Zustand, Recoil) to share agency data. Update context when agency profile changes.</constraint>
    <constraint>Form Patterns: Use controlled form components (React Hook Form recommended). Client-side validation mirrors server-side validation (DRY principle). Optimistic UI updates for better UX (update UI immediately, rollback on error).</constraint>
    <constraint>Database Schema: Extend agencies table with: name VARCHAR(255) NOT NULL, contact_email VARCHAR(255), contact_phone VARCHAR(50), currency VARCHAR(10) DEFAULT 'AUD' NOT NULL, timezone VARCHAR(100) DEFAULT 'Australia/Sydney' NOT NULL.</constraint>
    <constraint>Timezone Handling: Store all dates in UTC in database. Convert to agency timezone only for display. Use date-fns-tz or moment-timezone. Test with: UTC, America/New_York, Australia/Sydney, Europe/London.</constraint>
    <constraint>Folder Structure: Follow Next.js 14 App Router conventions (/app for pages and API routes). Follow structure from Story 1.1: /lib, /components, /types.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>PATCH /api/agencies/[id]</name>
      <kind>REST endpoint</kind>
      <signature>PATCH /api/agencies/[id] - Body: { name: string, contact_email?: string, contact_phone?: string, currency: string, timezone: string } - Response: { agency: Agency } | { error: string }</signature>
      <path>app/api/agencies/[id]/route.ts</path>
    </interface>
    <interface>
      <name>Agency</name>
      <kind>TypeScript interface</kind>
      <signature>interface Agency { id: string; agency_id: string; name: string; contact_email?: string; contact_phone?: string; currency: string; timezone: string; created_at: string; updated_at: string; }</signature>
      <path>types/agency.ts</path>
    </interface>
    <interface>
      <name>convertToAgencyTimezone</name>
      <kind>function signature</kind>
      <signature>function convertToAgencyTimezone(utcDate: Date | string, timezone: string): string</signature>
      <path>lib/timezone.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Testing infrastructure will be established in Story 1.4 (Error Handling &amp; Logging Infrastructure). Expected frameworks: Jest for unit tests, React Testing Library for component tests, Playwright or Cypress for E2E tests. All tests should follow TypeScript strict mode. Test files colocated with source or in dedicated __tests__ directories.</standards>
    <locations>
      - __tests__/ (if using centralized test directory)
      - *.test.ts, *.test.tsx (colocated with source files)
      - e2e/ or tests/e2e/ (for end-to-end tests)
    </locations>
    <ideas>
      <test ac="1">
        <description>Unit test: Timezone conversion utility</description>
        <details>Test convertToAgencyTimezone() with various timezone inputs: UTC, America/New_York, Australia/Sydney, Europe/London. Verify correct conversion from UTC to target timezone.</details>
      </test>
      <test ac="1,2">
        <description>Unit test: API validation logic</description>
        <details>Test Zod schema validation for agency profile fields. Verify required fields (name, currency, timezone), optional fields (contact_email, contact_phone), and invalid inputs are handled correctly.</details>
      </test>
      <test ac="1,2">
        <description>Integration test: PATCH /api/agencies/[id] - Success case</description>
        <details>Authenticated admin user updates agency profile with valid data. Verify: 200 response, updated agency data returned, database updated, RLS enforced (can only update own agency).</details>
      </test>
      <test ac="2">
        <description>Integration test: PATCH /api/agencies/[id] - Authorization failure</description>
        <details>Non-admin user attempts to update agency profile. Verify: 403 Forbidden response. User attempts to update different agency. Verify: 403 Forbidden (RLS enforced).</details>
      </test>
      <test ac="2">
        <description>Integration test: PATCH /api/agencies/[id] - Validation failure</description>
        <details>Submit invalid data (missing required fields, invalid timezone string, etc.). Verify: 400 Bad Request with descriptive error messages.</details>
      </test>
      <test ac="1,3">
        <description>E2E test: Agency settings page workflow</description>
        <details>Login as admin → Navigate to /settings/agency → Edit agency name, currency, timezone → Save → Verify: Success message shown, agency name updated in header, form reflects saved values.</details>
      </test>
      <test ac="4">
        <description>E2E test: Timezone display verification</description>
        <details>Change agency timezone to different value → Navigate to pages with timestamps → Verify all timestamps display in new timezone (not UTC or previous timezone).</details>
      </test>
      <test ac="1">
        <description>Component test: Agency settings form validation</description>
        <details>Test client-side form validation: required field errors, email format validation, timezone dropdown selection. Verify form cannot be submitted with invalid data.</details>
      </test>
    </ideas>
  </tests>
</story-context>
