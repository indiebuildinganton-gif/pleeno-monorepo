# Story 7-3: PDF Export Functionality - Task 4

**Story**: PDF Export Functionality
**Task**: Include Report Metadata and Filters
**Acceptance Criteria**: AC #2
**Previous Tasks**: Tasks 1-3 (API Route, PDF Components, Logo) - Should be completed

## User Story Context

**As a** Agency Admin
**I want** to see report metadata and applied filters in my PDF exports
**So that** I understand the scope and parameters of the exported data

## Task Description

Enhance the PDF header with comprehensive report metadata (title, generation date, user info) and a dedicated filters section that displays all applied filters in human-readable format.

## Subtasks Checklist

- [ ] Add report metadata section to PDF header:
  - Report title: "Payment Plans Report"
  - Generation date: "Generated on Nov 13, 2025 at 10:30 AM Brisbane"
  - Generated by: User name and email
- [ ] Add filters section showing applied filters:
  - Date range: "From Nov 1, 2025 to Nov 30, 2025"
  - College/Branch: "College Name - Branch Name" (if filtered)
  - Student: "Student Name" (if filtered)
  - Status: "Active, Completed" (if filtered)
  - Contract expiration: "Expiring between Dec 1 - Dec 31, 2025" (if filtered)
- [ ] Format filters as human-readable labels (not raw values)
- [ ] If no filters applied, show "All payment plans"
- [ ] Test: Generate PDF with various filters â†’ Verify all filters displayed

## Acceptance Criteria

**AC #2**: And the PDF includes: agency logo/name, report title, generation date, filters applied

## Context & Constraints

### Key Constraints
- **Professional Styling**: Use consistent branding, proper typography
- **Timezone**: Display dates/times in Brisbane timezone
- **Human-Readable**: Convert database values to friendly labels (UUIDs to names, status codes to labels)

### Relevant Interfaces

**Date Formatting**
- Package: `date-fns` and `date-fns-tz`
- Format: "Generated on Nov 13, 2025 at 10:30 AM Brisbane"
- Timezone: Australia/Brisbane

### Dependencies

**Required:**
- Task 2 completed (PDFReportHeader and PDFFiltersSection components exist)
- Task 3 completed (Logo integration done)
- Access to user session data (name, email)
- Access to filter data from API route

### Artifacts & References

**Code References:**
- `packages/ui/src/pdf/PDFReportHeader.tsx` - Update with metadata section
- `packages/ui/src/pdf/PDFFiltersSection.tsx` - Implement filter display logic
- `apps/reports/app/api/reports/payment-plans/export/route.ts` - Pass filter data to components

## Update Manifest

Before starting implementation:
1. Open `.bmad-ephemeral/stories/prompts/7-3/manifest.md`
2. Update Task 3 status to "Completed" with completion date
3. Update Task 4 status to "In Progress" with start date
4. Add implementation notes from Task 3

## Implementation Guidelines

### Step 1: Enhance PDFReportHeader with Metadata

Update `packages/ui/src/pdf/PDFReportHeader.tsx`:

```tsx
import { format } from 'date-fns';
import { formatInTimeZone } from 'date-fns-tz';

interface PDFReportHeaderProps {
  agency: { name: string; logo_url?: string; contact_email?: string };
  reportTitle: string;
  generatedAt: Date;
  generatedBy: { name: string; email: string };
}

// Format generation timestamp
const formattedDate = formatInTimeZone(
  generatedAt,
  'Australia/Brisbane',
  "MMMM d, yyyy 'at' h:mm a"
);
// Result: "November 13, 2025 at 10:30 AM"

// Display structure:
// 1. Logo/Agency Name (from Task 3)
// 2. Report Title: "Payment Plans Report"
// 3. Generation Info: "Generated on {formattedDate} Brisbane"
// 4. Generated By: "{user.name} ({user.email})"
```

### Step 2: Implement PDFFiltersSection Component

Create comprehensive filter display logic in `packages/ui/src/pdf/PDFFiltersSection.tsx`:

```tsx
interface FiltersSectionProps {
  filters: {
    date_from?: string;
    date_to?: string;
    college?: { id: string; name: string };
    branch?: { id: string; name: string };
    student?: { id: string; name: string };
    status?: string[];
    contract_expiration_from?: string;
    contract_expiration_to?: string;
  };
}

// Convert filters to human-readable strings:
// - Date range: "From Nov 1, 2025 to Nov 30, 2025"
// - College/Branch: "XYZ College - Downtown Branch"
// - Student: "John Smith"
// - Status: "Active, Completed, On Hold"
// - Contract expiration: "Expiring between Dec 1, 2025 - Dec 31, 2025"
```

### Step 3: Filter Formatting Utilities

Create helper functions:

```typescript
// Format date range
function formatDateRange(from?: string, to?: string): string {
  if (!from && !to) return '';
  if (from && to) return `From ${format(new Date(from), 'MMM d, yyyy')} to ${format(new Date(to), 'MMM d, yyyy')}`;
  if (from) return `From ${format(new Date(from), 'MMM d, yyyy')}`;
  if (to) return `Until ${format(new Date(to), 'MMM d, yyyy')}`;
}

// Format entity filter (college/branch/student)
function formatEntityFilter(entity?: { name: string }): string {
  return entity ? entity.name : '';
}

// Format status array
function formatStatusFilter(statuses?: string[]): string {
  if (!statuses || statuses.length === 0) return '';
  return statuses.join(', ');
}

// Format contract expiration
function formatExpirationFilter(from?: string, to?: string): string {
  if (!from && !to) return '';
  return `Expiring between ${format(new Date(from), 'MMM d, yyyy')} - ${format(new Date(to), 'MMM d, yyyy')}`;
}
```

### Step 4: Update API Route to Fetch Related Data

In `apps/reports/app/api/reports/payment-plans/export/route.ts`:

- Fetch college/branch/student names (not just IDs) for filter display
- Get current user info (name, email) from session
- Pass all context to PDF components

```typescript
// Query filter entities
const filtersWithNames = {
  date_from: filters.date_from,
  date_to: filters.date_to,
  college: filters.college_id ? await fetchCollegeName(filters.college_id) : undefined,
  branch: filters.branch_id ? await fetchBranchName(filters.branch_id) : undefined,
  student: filters.student_id ? await fetchStudentName(filters.student_id) : undefined,
  status: filters.status,
  contract_expiration_from: filters.contract_expiration_from,
  contract_expiration_to: filters.contract_expiration_to,
};

// Get user info from session
const user = await getCurrentUser();
```

### Step 5: Styling for Metadata and Filters

In `packages/ui/src/pdf/pdf-styles.ts`:

```typescript
const styles = StyleSheet.create({
  metadataSection: {
    marginTop: 10,
    marginBottom: 15,
    padding: 10,
    backgroundColor: '#f5f5f5',
  },
  reportTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 5,
  },
  generationInfo: {
    fontSize: 10,
    color: '#666',
    marginBottom: 2,
  },
  filtersSection: {
    marginBottom: 15,
    padding: 10,
    backgroundColor: '#e3f2fd',
    borderLeft: '3px solid #2196f3',
  },
  filterLabel: {
    fontSize: 9,
    fontWeight: 'bold',
    marginBottom: 3,
  },
  filterValue: {
    fontSize: 9,
    marginBottom: 5,
  },
});
```

## Implementation Notes

### What Was Completed in Previous Tasks
- Task 1: API route for PDF export
- Task 2: PDF components structure (header, filters section)
- Task 3: Logo upload and display in header

### How This Task Builds On Previous Work
- Enhances PDFReportHeader with metadata (builds on Task 2)
- Implements PDFFiltersSection logic (component created in Task 2)
- Uses user session data from API route (Task 1)

### Key Technical Decisions

**Date Formatting**:
- Use date-fns-tz for timezone support
- Brisbane timezone for Australian context
- Friendly format: "November 13, 2025 at 10:30 AM"

**Filter Display**:
- Human-readable labels instead of technical values
- Show "All payment plans" when no filters applied
- Group related filters logically

## Next Steps

After completing this task:
1. Update manifest.md - mark Task 4 as "Completed" with date
2. Add notes about metadata and filter display implementation
3. Move to `task-5-prompt.md` to implement data table formatting and pagination
4. Task 5 will focus on the main content area of the PDF

## Testing Checklist

- [ ] Report title displays correctly: "Payment Plans Report"
- [ ] Generation date formatted correctly with Brisbane timezone
- [ ] Generated by info shows user name and email
- [ ] Date range filter displays correctly
- [ ] College/Branch filter shows names (not IDs)
- [ ] Student filter shows name (not ID)
- [ ] Status filter shows all selected statuses
- [ ] Contract expiration filter displays correctly
- [ ] "All payment plans" shows when no filters applied
- [ ] Filter section styled correctly with background color
- [ ] All metadata and filters visible in PDF export
