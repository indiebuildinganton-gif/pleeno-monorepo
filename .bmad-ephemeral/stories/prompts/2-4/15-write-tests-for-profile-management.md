# Story 2-4: # Story 2.4: User Profile Management
## Task 15: Write tests for profile management

**Story Context:**
- **As a** Agency User or Admin
- **I want** to manage my own profile information
- **So that** my account information is accurate and I can change my password

**Acceptance Criteria:** 1-10

**This Task:**
Write tests for profile management

**Subtasks:**
1. Test: User can update their full name (200)
2. Test: User can view but not edit email, role, agency (read-only display)
3. Test: User can change password with correct current password (200)
4. Test: Password change fails with incorrect current password (401)
5. Test: New password must meet requirements (400)
6. Test: Regular user cannot change own email via API (403)
7. Test: Admin can initiate email change for any user (200)
8. Test: Email verification token generated correctly
9. Test: Email verification succeeds with valid token (200)
10. Test: Email verification fails with invalid token (400)
11. Test: Email verification fails with expired token (400)
12. Test: Email change logged in audit trail
13. Test: Password change logged in audit trail (no password values)
14. Test: RLS prevents users from changing other users' profiles

**Instructions:**

Read the full story context from:
- Story file: .bmad-ephemeral/stories/2-4-user-profile-management.md
- Context file: .bmad-ephemeral/stories/2-4-user-profile-management.context.xml

Then implement this task according to:
1. The acceptance criteria (AC: 1-10)
2. The Dev Notes section in the story file
3. The Architecture Alignment section
4. The Security Considerations section

**Development Guidelines:**
- Follow the project structure specified in the story
- Use the API route patterns from architecture.md
- Implement RLS policies as specified
- Add appropriate error handling with handleApiError()
- Use Zod validation schemas
- Follow TypeScript best practices
- Add inline comments for complex logic
- Consider security implications at every step

**Testing:**
- Write unit tests for new functions
- Write integration tests for API routes
- Ensure RLS policies are tested
- Test error cases and edge cases

**When Complete:**
- Mark the task checkbox as done in the story file
- Update the manifest file
- Document any deviations or issues encountered
- Note any follow-up tasks discovered

---
*Generated by execute-dev-story-claude-code-web workflow*
