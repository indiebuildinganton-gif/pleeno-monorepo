<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>Student-College Enrollment Linking</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>.bmad-ephemeral/stories/3-3-student-college-enrollment-linking.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Agency User</asA>
    <iWant>to link students to their enrolled colleges through payment plan creation with supporting documentation</iWant>
    <soThat>I can track where each student is studying, store official offer letters, and manage payments for multiple enrollments</soThat>
    <tasks>
      <task id="1" ac="1,3,4,6">Database Schema Implementation</task>
      <task id="2" ac="1,4,6">Enrollment API Routes</task>
      <task id="3" ac="1,5">Offer Letter Upload API</task>
      <task id="4" ac="2,5">Offer Letter Download API</task>
      <task id="5" ac="1">Payment Plan Creation Integration</task>
      <task id="6" ac="2,3">Student Detail Page - Enrollments Section</task>
      <task id="7" ac="2">College Detail Page - Enrolled Students Section</task>
      <task id="8" ac="2,5">Document Viewer Component</task>
      <task id="9" ac="4">Enrollment Status Management UI</task>
      <task id="10" ac="6">Duplicate Enrollment Handling Logic</task>
      <task id="11" ac="all">Audit Logging</task>
      <task id="12" ac="all">Testing</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1" title="Enrollment Creation via Payment Plan">
      <requirement>When creating a payment plan, select a student from dropdown</requirement>
      <requirement>Select a college/branch from dropdown</requirement>
      <requirement>Specify the program/course name</requirement>
      <requirement>Attach official offer letter (PDF/image) to the enrollment</requirement>
      <requirement>Student-college enrollment automatically created/linked when payment plan is saved</requirement>
    </criterion>
    <criterion id="2" title="Enrollment Display and Navigation">
      <requirement>View all enrollments for a student with attached documents on student detail page</requirement>
      <requirement>View all enrolled students for a college/branch on college detail page</requirement>
      <requirement>View/download/maximize offer letter from both student and college detail pages</requirement>
    </criterion>
    <criterion id="3" title="Multiple Enrollment Support">
      <requirement>Student can have multiple payment plans for different colleges/branches</requirement>
      <requirement>Student can have multiple payment plans for same college/branch (different courses)</requirement>
      <requirement>Incomplete student information (e.g., missing phone) can be added/updated later manually</requirement>
    </criterion>
    <criterion id="4" title="Enrollment Status Management">
      <requirement>Mark enrollment as completed or cancelled from student or college detail page</requirement>
      <requirement>Status options: 'active', 'completed', 'cancelled'</requirement>
    </criterion>
    <criterion id="5" title="Document Management">
      <requirement>Upload offer letters during payment plan creation</requirement>
      <requirement>Support PDF and image formats</requirement>
      <requirement>View/download/maximize documents from student and college detail pages</requirement>
      <requirement>RLS policies protect documents (users can only access their agency's documents)</requirement>
    </criterion>
    <criterion id="6" title="Duplicate Enrollment Handling">
      <requirement>If student-branch-program combination exists, reuse enrollment</requirement>
      <requirement>Otherwise create new enrollment record</requirement>
      <requirement>Allow partial student data (mark required vs optional fields)</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 3: Core Entity Management</title>
        <section>Story 3.3: Student-College Enrollment Linking</section>
        <snippet>Links students to colleges through payment plan creation. Enrollments table stores student-branch-program associations with offer letter documents. Supports multiple enrollments per student.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture - Multi-Zone Structure</title>
        <section>Epic 3 Mapping</section>
        <snippet>Epic 3 maps to apps/entities/ zone and entities_domain database. Uses TanStack Table for College/Student CRUD. Enrollments integrate with apps/payments/ zone for payment plan creation.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Project Structure - Entities Domain</title>
        <section>Monorepo Architecture</section>
        <snippet>Enrollment components span apps/entities/ (student/college detail pages) and apps/payments/ (payment plan wizard). Shared components in packages/ui/src/components/enrollments/. Database migrations in supabase/migrations/002_entities_domain/.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>File Upload Pattern</title>
        <section>Novel Pattern Designs</section>
        <snippet>Supabase Storage with RLS for document uploads. Storage path: enrollment-documents/{enrollment_id}/{filename}. Validate file type (PDF, JPEG, PNG) and size (max 10MB). Store metadata in table (offer_letter_url, offer_letter_filename).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Technology Stack</title>
        <section>Core Technologies</section>
        <snippet>Next.js 15 with App Router, TypeScript 5, Supabase PostgreSQL with RLS, TanStack Query 5.90.7 for server state, React Hook Form 7.66.0 for forms, Zod 4.x for validation, Shadcn UI components.</snippet>
      </doc>
      <doc>
        <path>.bmad-ephemeral/stories/3-2-student-registry.md</path>
        <title>Previous Story: Student Registry</title>
        <section>Learnings from Story 3.2</section>
        <snippet>Established students table, file upload utilities in packages/utils/src/file-upload.ts, document viewer component pattern, RLS policies for multi-tenant isolation, student detail page structure ready for enrollment section.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>packages/utils/src/file-upload.ts</path>
        <kind>utility</kind>
        <symbol>uploadDocument, deleteDocument</symbol>
        <lines>reference</lines>
        <reason>File upload utilities from Story 3.2 to adapt for offer letter uploads</reason>
      </artifact>
      <artifact>
        <path>packages/utils/src/enrollment-helpers.ts</path>
        <kind>utility</kind>
        <symbol>findOrCreateEnrollment</symbol>
        <lines>new</lines>
        <reason>NEW: Handle duplicate enrollment logic - check (student_id, branch_id, program_name), reuse or create</reason>
      </artifact>
      <artifact>
        <path>packages/ui/src/components/enrollments/DocumentViewer.tsx</path>
        <kind>component</kind>
        <symbol>DocumentViewer</symbol>
        <lines>new</lines>
        <reason>NEW: Reusable document viewer for offer letters with PDF preview and maximize/fullscreen</reason>
      </artifact>
      <artifact>
        <path>packages/ui/src/components/enrollments/EnrollmentStatusBadge.tsx</path>
        <kind>component</kind>
        <symbol>EnrollmentStatusBadge</symbol>
        <lines>new</lines>
        <reason>NEW: Status badge component (active=green, completed=blue, cancelled=gray)</reason>
      </artifact>
      <artifact>
        <path>apps/entities/app/students/[id]/components/EnrollmentsSection.tsx</path>
        <kind>component</kind>
        <symbol>EnrollmentsSection</symbol>
        <lines>new</lines>
        <reason>NEW: Display enrollments list on student detail page with offer letter links</reason>
      </artifact>
      <artifact>
        <path>apps/entities/app/colleges/[id]/components/EnrolledStudentsSection.tsx</path>
        <kind>component</kind>
        <symbol>EnrolledStudentsSection</symbol>
        <lines>new</lines>
        <reason>NEW: Display enrolled students list on college detail page</reason>
      </artifact>
      <artifact>
        <path>apps/payments/app/plans/new/components/PaymentPlanWizard.tsx</path>
        <kind>component</kind>
        <symbol>PaymentPlanWizard</symbol>
        <lines>update</lines>
        <reason>UPDATE: Add enrollment creation logic to payment plan creation wizard Step 1</reason>
      </artifact>
      <artifact>
        <path>apps/payments/app/plans/new/components/OfferLetterUpload.tsx</path>
        <kind>component</kind>
        <symbol>OfferLetterUpload</symbol>
        <lines>new</lines>
        <reason>NEW: File upload component for offer letters in payment plan wizard</reason>
      </artifact>
      <artifact>
        <path>supabase/migrations/002_entities_domain/006_enrollments_schema.sql</path>
        <kind>migration</kind>
        <symbol>enrollments table</symbol>
        <lines>new</lines>
        <reason>NEW: Create enrollments table with agency_id, student_id, branch_id, program_name, offer_letter_url, status ENUM</reason>
      </artifact>
      <artifact>
        <path>supabase/migrations/002_entities_domain/007_enrollments_rls.sql</path>
        <kind>migration</kind>
        <symbol>RLS policies</symbol>
        <lines>new</lines>
        <reason>NEW: RLS policies for enrollments table and enrollment-documents storage bucket</reason>
      </artifact>
      <artifact>
        <path>supabase/migrations/002_entities_domain/008_payment_plans_fk.sql</path>
        <kind>migration</kind>
        <symbol>foreign key</symbol>
        <lines>new</lines>
        <reason>NEW: Add enrollment_id foreign key column to payment_plans table</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="@supabase/supabase-js" version="latest" />
        <package name="@supabase/ssr" version="latest" />
        <package name="@tanstack/react-query" version="5.90.7" />
        <package name="react-hook-form" version="7.66.0" />
        <package name="@hookform/resolvers" version="latest" />
        <package name="zod" version="4.x" />
        <package name="date-fns" version="4.1.0" />
        <package name="date-fns-tz" version="latest" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Multi-Zone Architecture: Enrollment management spans apps/entities/ and apps/payments/ zones. Share enrollment components via packages/ui/src/components/enrollments/.</constraint>
    <constraint>Row-Level Security (RLS): All queries automatically filtered by agency_id. Apply RLS to enrollments table and enrollment-documents storage bucket.</constraint>
    <constraint>Foreign Key Relationship: payment_plans.enrollment_id → enrollments.id creates 1:1 relationship. Enrollment must be created BEFORE payment plan.</constraint>
    <constraint>Composite Uniqueness: Enrollments table uses (student_id, branch_id, program_name) for duplicate prevention. Check before creating new enrollment.</constraint>
    <constraint>File Upload Constraints: Supabase Storage path enrollment-documents/{enrollment_id}/{filename}. Validate file type (PDF, JPEG, PNG), max size 10MB. Store metadata in enrollments table.</constraint>
    <constraint>Status Enum: Enrollment status must be one of: 'active', 'completed', 'cancelled'. Default to 'active' on creation.</constraint>
    <constraint>Multiple Enrollments: Student can have multiple enrollments for different colleges/branches or same college/branch with different programs.</constraint>
    <constraint>State Management: Use TanStack Query for enrollment data. Use React Hook Form for payment plan wizard. Use Zustand for document viewer UI state.</constraint>
    <constraint>Testing Requirements: Integration tests for API endpoints. E2E test for payment plan → enrollment creation flow. Test RLS policies for multi-tenant isolation.</constraint>
    <constraint>Audit Logging: Log all enrollment CRUD operations to audit_logs table. Include user_id, timestamp, entity_type='enrollment', old/new values.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/enrollments</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/enrollments { student_id, branch_id, program_name, offer_letter_file? } → { enrollment_id, ...enrollment_data }</signature>
      <path>apps/payments/app/api/enrollments/route.ts (new)</path>
      <notes>Called internally by payment plan creation. Handles duplicate check: if (student_id, branch_id, program_name) exists with status='active', reuse enrollment_id.</notes>
    </interface>
    <interface>
      <name>GET /api/enrollments/[id]</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/enrollments/[id] → { enrollment_id, student, branch, college, program_name, status, offer_letter_url }</signature>
      <path>apps/entities/app/api/enrollments/[id]/route.ts (new)</path>
      <notes>Returns enrollment detail with populated student and branch/college data.</notes>
    </interface>
    <interface>
      <name>PATCH /api/enrollments/[id]</name>
      <kind>REST endpoint</kind>
      <signature>PATCH /api/enrollments/[id] { status: 'completed' | 'cancelled' } → { enrollment_id, status }</signature>
      <path>apps/entities/app/api/enrollments/[id]/route.ts (new)</path>
      <notes>Updates enrollment status. Logs change to audit_logs.</notes>
    </interface>
    <interface>
      <name>GET /api/students/[id]/enrollments</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/students/[id]/enrollments → { enrollments: [...] }</signature>
      <path>apps/entities/app/api/students/[id]/enrollments/route.ts (new)</path>
      <notes>Returns all enrollments for student with branch/college info and offer letter URLs.</notes>
    </interface>
    <interface>
      <name>GET /api/branches/[id]/enrollments</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/branches/[id]/enrollments → { enrollments: [...] }</signature>
      <path>apps/entities/app/api/branches/[id]/enrollments/route.ts (new)</path>
      <notes>Returns all enrolled students for branch with enrollment status and offer letters.</notes>
    </interface>
    <interface>
      <name>POST /api/enrollments/[id]/offer-letter</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/enrollments/[id]/offer-letter { file: File } → { offer_letter_url, offer_letter_filename }</signature>
      <path>apps/entities/app/api/enrollments/[id]/offer-letter/route.ts (new)</path>
      <notes>Uploads offer letter to Supabase Storage. Validates file type and size. Updates enrollments table metadata.</notes>
    </interface>
    <interface>
      <name>GET /api/enrollments/[id]/offer-letter</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/enrollments/[id]/offer-letter → File (PDF/image)</signature>
      <path>apps/entities/app/api/enrollments/[id]/offer-letter/route.ts (new)</path>
      <notes>Serves offer letter file with proper Content-Type and Content-Disposition headers. Checks RLS permissions.</notes>
    </interface>
    <interface>
      <name>findOrCreateEnrollment</name>
      <kind>function</kind>
      <signature>findOrCreateEnrollment(student_id, branch_id, program_name) → Promise&lt;enrollment_id&gt;</signature>
      <path>packages/utils/src/enrollment-helpers.ts (new)</path>
      <notes>Checks if enrollment exists. If found with status='active', returns existing id. If 'cancelled', creates new. If not found, creates new.</notes>
    </interface>
    <interface>
      <name>uploadOfferLetter</name>
      <kind>function</kind>
      <signature>uploadOfferLetter(enrollment_id, file: File) → Promise&lt;{ url, filename }&gt;</signature>
      <path>packages/utils/src/file-upload.ts (update)</path>
      <notes>Uploads offer letter to enrollment-documents/{enrollment_id}/{filename}. Validates file type and size. Returns storage URL.</notes>
    </interface>
    <interface>
      <name>Enrollments Table Schema</name>
      <kind>database schema</kind>
      <signature>CREATE TABLE enrollments (id UUID, agency_id UUID, student_id UUID, branch_id UUID, program_name TEXT, offer_letter_url TEXT, offer_letter_filename TEXT, status ENUM('active','completed','cancelled'), created_at, updated_at, UNIQUE(student_id, branch_id, program_name))</signature>
      <path>supabase/migrations/002_entities_domain/006_enrollments_schema.sql (new)</path>
      <notes>Composite unique constraint prevents duplicate student-branch-program combinations. Foreign keys to students and branches tables.</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest for unit tests, React Testing Library for component tests, and Playwright for E2E tests. Place unit tests alongside source files with .test.ts extension. Integration tests in __tests__/ directory. E2E tests in __tests__/e2e/. Test RLS policies by attempting cross-agency data access (should fail). Test file uploads with valid/invalid types and sizes.</standards>
    <locations>
      <location>packages/utils/src/__tests__/enrollment-helpers.test.ts</location>
      <location>packages/utils/src/__tests__/file-upload.test.ts</location>
      <location>apps/entities/__tests__/enrollments-api.test.ts</location>
      <location>apps/payments/__tests__/payment-plan-enrollment-integration.test.ts</location>
      <location>__tests__/e2e/enrollment-creation-flow.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="1,6">Test enrollment creation via payment plan wizard - verify enrollment record created with correct student/branch/program</idea>
      <idea ac="1,6">Test duplicate enrollment handling - create enrollment with same student-branch-program twice, verify second reuses first</idea>
      <idea ac="1,6">Test cancelled enrollment re-enrollment - create enrollment, cancel it, create again with same combo, verify new enrollment created</idea>
      <idea ac="1,5">Test offer letter upload - upload PDF, verify stored in correct path, metadata saved in table</idea>
      <idea ac="5">Test offer letter upload validation - try invalid file types (DOC, TXT), verify rejected. Try oversized file (>10MB), verify rejected</idea>
      <idea ac="2,5">Test offer letter download - upload document, download via API, verify correct Content-Type headers</idea>
      <idea ac="2">Test student enrollments list - create multiple enrollments for student, fetch via /api/students/[id]/enrollments, verify all returned</idea>
      <idea ac="2">Test branch enrollments list - create enrollments for multiple students at same branch, fetch via /api/branches/[id]/enrollments, verify all returned</idea>
      <idea ac="4">Test enrollment status update - change status from active to completed, verify saved and logged in audit_logs</idea>
      <idea ac="3">Test multiple enrollments per student - create 3 enrollments for same student (different colleges/programs), verify all accessible</idea>
      <idea ac="all">Test RLS policies - create agency A enrollment, attempt access from agency B user, verify forbidden</idea>
      <idea ac="all">Test RLS on storage - upload offer letter for agency A, attempt download from agency B user, verify forbidden</idea>
      <idea ac="1">E2E: Full payment plan creation flow - select student, college/branch, upload offer letter, save plan, verify enrollment created</idea>
      <idea ac="2">E2E: Document viewer - click "View Offer Letter" on student detail page, verify PDF opens in modal with maximize option</idea>
    </ideas>
  </tests>
</story-context>
