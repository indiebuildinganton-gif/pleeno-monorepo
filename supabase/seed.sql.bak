-- ============================================================
-- Development Seed Data
-- ============================================================
-- This file seeds the database with sample data for development
-- It creates a sample agency, users, and basic data to get started quickly
--
-- Usage:
--   npm run db:seed
--
-- Credentials:
--   Admin: admin@pleeno.dev / Admin123!
--   User:  user@pleeno.dev / User123!
-- ============================================================

BEGIN;

-- ============================================================
-- STEP 1: Clear existing data (for clean re-seeding)
-- ============================================================

-- Delete users (cascades to related tables)
DELETE FROM public.users;

-- Delete agencies (cascades to related tables)
DELETE FROM public.agencies;

-- Clear auth.users (Supabase Auth)
-- Note: This requires service role access
DELETE FROM auth.users;

-- ============================================================
-- STEP 2: Create Sample Agency
-- ============================================================

INSERT INTO public.agencies (id, name, created_at, updated_at)
VALUES (
  '00000000-0000-0000-0000-000000000001',
  'Demo Agency',
  NOW(),
  NOW()
);

-- ============================================================
-- STEP 3: Create Auth Users
-- ============================================================

-- Create admin user in auth.users
-- Password: Admin123!
-- Hashed using bcrypt (this is a placeholder - Supabase handles this)
INSERT INTO auth.users (
  instance_id,
  id,
  aud,
  role,
  email,
  encrypted_password,
  email_confirmed_at,
  raw_app_meta_data,
  raw_user_meta_data,
  created_at,
  updated_at,
  confirmation_token,
  email_change,
  email_change_token_new,
  recovery_token
) VALUES (
  '00000000-0000-0000-0000-000000000000',
  '10000000-0000-0000-0000-000000000001',
  'authenticated',
  'authenticated',
  'admin@pleeno.dev',
  -- Password: Admin123!
  '$2a$10$Z8qLKzrVqG5vJQmzXvRlbO9x6yGqjNqYJGxJ0YQF8YQmZqGqGqGqG',
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"full_name":"Admin User","agency_id":"00000000-0000-0000-0000-000000000001","role":"agency_admin"}',
  NOW(),
  NOW(),
  '',
  '',
  '',
  ''
);

-- Create regular user in auth.users
-- Password: User123!
INSERT INTO auth.users (
  instance_id,
  id,
  aud,
  role,
  email,
  encrypted_password,
  email_confirmed_at,
  raw_app_meta_data,
  raw_user_meta_data,
  created_at,
  updated_at,
  confirmation_token,
  email_change,
  email_change_token_new,
  recovery_token
) VALUES (
  '00000000-0000-0000-0000-000000000000',
  '10000000-0000-0000-0000-000000000002',
  'authenticated',
  'authenticated',
  'user@pleeno.dev',
  -- Password: User123!
  '$2a$10$Z8qLKzrVqG5vJQmzXvRlbO9x6yGqjNqYJGxJ0YQF8YQmZqGqGqGqG',
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"full_name":"Regular User","agency_id":"00000000-0000-0000-0000-000000000001","role":"agency_user"}',
  NOW(),
  NOW(),
  '',
  '',
  '',
  ''
);

-- ============================================================
-- STEP 4: Create Public Users
-- ============================================================

INSERT INTO public.users (id, email, full_name, agency_id, role, status, created_at, updated_at)
VALUES
  (
    '10000000-0000-0000-0000-000000000001',
    'admin@pleeno.dev',
    'Admin User',
    '00000000-0000-0000-0000-000000000001',
    'agency_admin',
    'active',
    NOW(),
    NOW()
  ),
  (
    '10000000-0000-0000-0000-000000000002',
    'user@pleeno.dev',
    'Regular User',
    '00000000-0000-0000-0000-000000000001',
    'agency_user',
    'active',
    NOW(),
    NOW()
  );

-- ============================================================
-- STEP 5: Create Identity Records (Required for Auth)
-- ============================================================

INSERT INTO auth.identities (
  id,
  user_id,
  identity_data,
  provider,
  last_sign_in_at,
  created_at,
  updated_at
) VALUES
  (
    '10000000-0000-0000-0000-000000000001',
    '10000000-0000-0000-0000-000000000001',
    '{"sub":"10000000-0000-0000-0000-000000000001","email":"admin@pleeno.dev"}',
    'email',
    NOW(),
    NOW(),
    NOW()
  ),
  (
    '10000000-0000-0000-0000-000000000002',
    '10000000-0000-0000-0000-000000000002',
    '{"sub":"10000000-0000-0000-0000-000000000002","email":"user@pleeno.dev"}',
    'email',
    NOW(),
    NOW(),
    NOW()
  );

-- ============================================================
-- STEP 6: Verification
-- ============================================================

DO $$
DECLARE
  agency_count INTEGER;
  user_count INTEGER;
  auth_user_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO agency_count FROM public.agencies;
  SELECT COUNT(*) INTO user_count FROM public.users;
  SELECT COUNT(*) INTO auth_user_count FROM auth.users;

  RAISE NOTICE '==============================================';
  RAISE NOTICE 'Seed data created successfully!';
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'Agencies created: %', agency_count;
  RAISE NOTICE 'Users created: %', user_count;
  RAISE NOTICE 'Auth users created: %', auth_user_count;
  RAISE NOTICE '';
  RAISE NOTICE 'Login credentials:';
  RAISE NOTICE '  Admin: admin@pleeno.dev / Admin123!';
  RAISE NOTICE '  User:  user@pleeno.dev / User123!';
  RAISE NOTICE '';
  RAISE NOTICE 'Visit: http://localhost:3005/login';
  RAISE NOTICE '==============================================';
END $$;

COMMIT;
